---
title: "Data Quality Visualizations"
author: "Zack Arno"
date: '2022-11-15'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Intro



```{r libs_data}
library(tidyverse)
library(here)

invisible(purrr::map(dir(here("R/"),full.names = T),~source(.x,verbose = FALSE,echo = F)))
targets::tar_load_everything()
```

## Iterative Cleaning 
- this might fit better into a different notebook, but i realized there is an issue with the coherence between admin 2 and admin 3 reporting



alright we have blank NA cols. This is being looked into, in the meantime let's patch it so we can continue

This patch needs to be added to cleaning rmd and then functionalized, then added to `{targets}` pipeline.. for now let's just use the code in place:
```{r}
# the pre 201905 can easily be taken are of by just removing these 2
# should add this to the `{targets}` cleaning pipeline:




RB_pre201905_df_compiled <- RB_pre201905_df_compiled |> 
  mutate(
  total_population = if_else(is.na(total_popn_census),total_popn_projected,total_popn_census)  
  ) |> 
  filter(!(year==2016 & adm2_name %in% c("west_gojam","east_gojam")))
  



# Now for the post data: 
RB_post201905_df_compiled <- RB_post201905_df_compiled |> 
  mutate(
  total_population = if_else(is.na(total_popn_census),total_popn_projected,total_popn_census)  
  ) |> 
  select(date,everything()) |>  # bring date to front
  group_by(adm1_name,adm2_name,adm3_name) |> 
  arrange(adm3_name,year,month,date) |> 
  tidyr::fill(total_population,.direction="downup") #first fill from down, then up sequential then reverse.

```


pre 201905 is only reported at admin 2 level - therefore let's summarise and simplify both to adm2
```{r}
RB_pre_adm2 <- RB_pre201905_df_compiled |> 
  summarise_to_adm2()

RB_post_adm2 <- RB_post201905_df_compiled |> 
  summarise_to_adm2()

RB_adm2 <-  bind_rows(RB_post_adm2,RB_pre_adm2) # combine
```



```{r}
pop_treated_gt_total_pop<- RB_adm2 |> 
  filter(
    popn_treated_during_current_month>total_population
  )

test <- RB_pre_post_compiled|> 
  filter(
    popn_treated_during_current_month>total_population
  )
```

We see there are now **`r nrow(pop_treated_gt_total_pop)`** cases where the reported # treated monthly is greater than the total population reported that month.

Let's visually inspect adm2 level monthly reported pop treated vs total population. There are some high outliers? anything to do about these?

```{r}
rb_boxplot(.data = RB_adm2,
           x = "adm2_name",
           y = "popn_treated_during_current_month",
           pop = "total_population" )
RB_adm2<-RB_adm2 |> 
  arrange(date)
RB_adm2 |> 
  filter(is.na(total_population))

RB_adm2_targets <-  RB_pre_post_compiled |>
  arrange(date)

RB_adm2_targets |> 
  filter(is.na(total_population)) |> 
  count(file_name ) |> 
  print(n=35)

 all(RB_adm2$total_population==RB_adm2_targets$total_population)

rb_boxplot(.data = RB_pre_post_compiled,
           x = "adm2_name",
           y = "popn_treated_during_current_month",
           pop = "total_population" )


# log scaled
rb_boxplot(.data = RB_adm2,
           x = "adm2_name",
           y = "popn_treated_during_current_month",
           pop = "total_population" ,log = T)



```

Shold fin out a bit more about cumulative all_rounds
```{r}
RB_adm2 |> 
  filter(
    popn_treated_cumulative_all_rounds>total_population
  )

RB_adm2$popn_treated_cumulative_all_rounds
rb_boxplot(.data = RB_adm2,
           x = "adm2_name",
           y = "popn_treated_cumulative_all_rounds",
           pop = "total_population" )
```


Now let's do the same just at the woreda (adm3/district level). We only have woreda level reporting for post 2019-05 data.
```{r}
pop_treated_gt_total_pop_adm3<- RB_post201905_df_compiled |> 
  filter(
    popn_treated_during_current_month>total_population
  )

pop_treated_gt_total_pop_adm3 |> count(date, adm3_name)
```
We see there are now **`r nrow(pop_treated_gt_total_pop_adm3)`** cases where the reported # treated monthly is greater than the total population reported that month.

```{r}
rb_boxplot(.data = RB_post201905_df_compiled,
           x = "adm3_name",
           y = "popn_treated_during_current_month",
           facet = "adm1_name",
           pop = "total_population" )


 # log scaled
rb_boxplot(.data = RB_adm2,
           x = "adm2_name",
           y = "popn_treated_during_current_month",
           pop = "total_population" ,log = T)

```

